<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexusHire - Enterprise Workspace</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- CSS VARIABLES & RESET --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        
        :root {
            --primary: #2563eb; 
            --primary-dark: #1d4ed8;
            --dark: #0f172a; 
            --light: #ffffff;
            --bg-body: #f8fafc;
            --border: #e2e8f0;
            --text-gray: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        body { background-color: var(--bg-body); color: var(--dark); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* NAVBAR */
        .navbar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 5%; height: 70px; background: rgba(255, 255, 255, 0.9); 
            border-bottom: 1px solid var(--border); backdrop-filter: blur(10px);
            flex-shrink: 0; z-index: 1001;
        }

        .logo { font-size: 1.4rem; font-weight: 800; color: var(--dark); cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .nav-group { display: flex; align-items: center; gap: 1rem; }
        .hidden { display: none !important; }

        .nav-link { 
            text-decoration: none; color: var(--text-gray); font-weight: 500; font-size: 0.9rem; 
            transition: all 0.2s; cursor: pointer; padding: 8px 16px; border-radius: 50px;
        }
        .nav-link:hover { color: var(--primary); background: #eff6ff; }
        .nav-link.active { color: white; background: var(--dark); }

        /* USER PROFILE */
        .user-profile-container { display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 5px 10px; border-radius: 8px; transition: 0.2s; }
        .user-profile-container:hover { background: #e2e8f0; }
        .user-avatar { width: 32px; height: 32px; background: var(--dark); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: 600; font-size: 0.85rem; }

        /* DROPDOWN */
        .profile-dropdown {
            position: absolute; top: 75px; right: 5%; background: white; width: 220px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-radius: 12px; border: 1px solid var(--border);
            padding: 6px; display: none; flex-direction: column; z-index: 2000;
        }
        .dropdown-item { padding: 10px; cursor: pointer; border-radius: 6px; font-size: 0.9rem; display: flex; align-items: center; gap: 10px; }
        .dropdown-item:hover { background: #f8fafc; color: var(--primary); }
        .dropdown-item.danger { color: var(--danger); border-top: 1px solid var(--border); margin-top: 5px; }
        .dropdown-item.danger:hover { background: #fef2f2; }

        /* BUTTONS */
        .btn-login { color: var(--dark); font-weight: 600; cursor: pointer; }
        .btn-signup { background: var(--dark); color: white; padding: 0.5rem 1.2rem; border-radius: 6px; font-weight: 600; border: none; cursor: pointer; }

        /* MAIN LAYOUT */
        .main-wrapper { flex: 1; overflow-y: auto; position: relative; scroll-behavior: smooth; }
        .view-section { display: none; padding: 2rem 5%; max-width: 1400px; margin: 0 auto; animation: fadeIn 0.4s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* HOME */
        .hero { background: var(--dark); color: white; padding: 5rem 2rem; text-align: center; border-radius: 0 0 24px 24px; margin-bottom: 3rem; }
        .search-box { background: white; max-width: 600px; margin: 2rem auto; padding: 0.5rem; border-radius: 50px; display: flex; }
        .search-box input { flex: 1; padding: 0 1.5rem; border: none; outline: none; }
        
        .job-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .job-card { 
            background: white; padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border); 
            transition: 0.2s; display: flex; flex-direction: column; justify-content: space-between; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.02); height: 100%;
        }
        .job-card:hover { transform: translateY(-4px); box-shadow: 0 15px 30px rgba(0,0,0,0.06); border-color: var(--primary); }
        .job-title { font-weight: 700; font-size: 1.05rem; margin-bottom: 0.5rem; }
        .job-budget { color: var(--success); font-weight: 700; background: #ecfdf5; padding: 4px 10px; border-radius: 6px; display: inline-block; font-size: 0.85rem;}
        .tags span { background: #f1f5f9; color: var(--text-gray); font-size: 0.75rem; padding: 4px 8px; border-radius: 4px; margin-right: 5px; font-weight: 600; }
        
        .apply-btn { 
            margin-top: 1.5rem; width: 100%; padding: 0.8rem; border: 1px solid var(--border); 
            color: var(--dark); background: white; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s; 
        }
        .apply-btn:hover { background: var(--dark); color: white; }
        .apply-btn.applied { background: #dcfce7; border-color: #dcfce7; color: var(--success); cursor: default; }
        
        .withdraw-btn {
            background: #fef2f2; color: var(--danger); border: 1px solid #fee2e2;
            padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem;
            margin-left: 10px; transition: 0.2s;
        }
        .withdraw-btn:hover { background: var(--danger); color: white; }

        /* DASHBOARD */
        .dashboard-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }
        .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border); display: flex; align-items: center; gap: 1rem; }
        .stat-icon { width: 50px; height: 50px; background: #f1f5f9; color: var(--primary); display: flex; align-items: center; justify-content: center; border-radius: 10px; font-size: 1.2rem; }
        .dash-card { background: white; padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; }
        
        .skill-bar { display: flex; align-items: center; margin-bottom: 10px; font-size: 0.9rem; }
        .skill-name { width: 80px; font-weight: 500; }
        .skill-progress { flex: 1; height: 8px; background: #f1f5f9; border-radius: 4px; overflow: hidden; margin: 0 10px; }
        .skill-fill { height: 100%; background: var(--primary); border-radius: 4px; }
        
        /* Activity Feed */
        .activity-item { display: flex; gap: 10px; padding: 12px 0; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; }
        .activity-time { color: #94a3b8; font-size: 0.8rem; margin-left: auto; }

        /* MESSAGES */
        .chat-layout { display: grid; grid-template-columns: 300px 1fr; gap: 0; height: 75vh; background: white; border-radius: 16px; border: 1px solid var(--border); overflow: hidden; }
        .chat-sidebar { border-right: 1px solid var(--border); background: #f8fafc; }
        .chat-item { padding: 1rem; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; gap: 10px; align-items: center; }
        .chat-item.active { background: white; border-left: 4px solid var(--primary); }
        .chat-main { display: flex; flex-direction: column; background: #fff; }
        .chat-messages { flex: 1; padding: 2rem; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .message { max-width: 75%; padding: 12px 18px; border-radius: 12px; font-size: 0.95rem; line-height: 1.5; }
        .msg-in { background: #f1f5f9; align-self: flex-start; }
        .msg-out { background: var(--primary); color: white; align-self: flex-end; }
        .chat-input { padding: 1.5rem; border-top: 1px solid var(--border); display: flex; gap: 10px; }
        .chat-input input { flex: 1; padding: 12px; border: 1px solid var(--border); border-radius: 8px; outline: none; }

        /* MODAL */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 3000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: white; padding: 2.5rem; border-radius: 16px; width: 90%; max-width: 400px; text-align: center; }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group input { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; }
        .modal-btn { width: 100%; background: var(--dark); color: white; padding: 12px; border: none; border-radius: 8px; cursor: pointer; }

        @media (max-width: 768px) {
            .navbar { padding: 0 1rem; }
            .nav-link span, .btn-login, .user-name-display { display: none; }
            .stats-row, .dashboard-grid, .chat-layout, .job-grid { grid-template-columns: 1fr; }
            .chat-sidebar { display: none; } 
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="logo" onclick="handleLogoClick()">
            <div style="width:30px;height:30px;background:var(--primary);border-radius:6px;display:flex;align-items:center;justify-content:center;color:white;"><i class="fas fa-layer-group"></i></div> NexusHire
        </div>
        
        <div class="nav-group" id="nav-guest">
            <a onclick="openModal('login')" class="btn-login">Log In</a>
            <button onclick="openModal('signup')" class="btn-signup">Sign Up</button>
        </div>

        <div class="nav-group hidden" id="nav-user">
            <a onclick="switchView('home')" class="nav-link active">Browse</a>
            <a onclick="switchView('dashboard')" class="nav-link">Dashboard</a>
            <a onclick="switchView('myjobs')" class="nav-link">My Jobs <span id="badge" style="background:var(--primary); color:white; padding:2px 6px; border-radius:10px; font-size:0.7rem; margin-left:5px;">0</span></a>
            <a onclick="switchView('messages')" class="nav-link">Messages</a>
            
            <div class="user-profile-container" onclick="toggleProfileMenu(event)">
                <div class="user-avatar" id="nav-avatar">U</div>
                <span class="user-name-display" id="nav-username">User</span>
                <i class="fas fa-chevron-down" style="font-size: 0.7rem; color: #94a3b8;"></i>
                
                <div id="profile-dropdown" class="profile-dropdown">
                    <div class="dropdown-item" onclick="switchView('dashboard')"><i class="fas fa-chart-pie"></i> Dashboard</div>
                    <div class="dropdown-item danger" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Log Out</div>
                </div>
            </div>
        </div>
    </nav>

    <div class="main-wrapper" onclick="closeDropdown()">
        
        <section id="view-home" class="view-section active">
            <div class="hero">
                <h1>Find your next enterprise project.</h1>
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="Search (e.g. React, Python, Design)...">
                    <button onclick="renderJobs()" style="background:var(--primary); color:white; border:none; padding: 0.8rem 2rem; border-radius:50px; font-weight:600; cursor:pointer;">Search</button>
                </div>
            </div>
            <div style="max-width: 1300px; margin: 0 auto;">
                <h2 style="margin-bottom: 1.5rem;">Latest Jobs (16)</h2>
                <div id="job-grid-container" class="job-grid"></div>
            </div>
        </section>

        <section id="view-dashboard" class="view-section">
            <div style="margin-bottom: 2rem;">
                <h2 id="dash-welcome">Dashboard</h2>
                <p style="color:var(--text-gray)">Real-time analytics based on your applications.</p>
            </div>

            <div class="dashboard-grid">
                <div>
                    <div class="stats-row">
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-coins"></i></div>
                            <div><div style="font-size:1.5rem;font-weight:700;" id="stat-potential-val">$0</div><div style="font-size:0.85rem;color:gray;">Pipeline Value</div></div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background:#ecfdf5;color:var(--success)"><i class="fas fa-briefcase"></i></div>
                            <div><div style="font-size:1.5rem;font-weight:700;" id="stat-active-jobs">0</div><div style="font-size:0.85rem;color:gray;">Active Jobs</div></div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background:#fffbeb;color:#f59e0b"><i class="fas fa-chart-line"></i></div>
                            <div><div style="font-size:1.5rem;font-weight:700;">Top 10%</div><div style="font-size:0.85rem;color:gray;">Applicant Rank</div></div>
                        </div>
                    </div>

                    <div class="dash-card">
                        <div style="font-weight:700; margin-bottom:1rem;">Your Targeted Skills</div>
                        <div id="skills-container">
                            <p style="color:gray; font-size:0.9rem;">Apply to jobs to see your skill profile.</p>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="dash-card">
                        <div style="font-weight:700; margin-bottom:1rem;">Recent Activity</div>
                        <div id="activity-feed"></div>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-myjobs" class="view-section">
            <h2 style="margin-bottom: 1.5rem;">My Applications</h2>
            <div id="my-jobs-grid" class="job-grid"></div>
        </section>

        <section id="view-messages" class="view-section">
            <h2 style="margin-bottom: 1.5rem;">Messages</h2>
            <div class="chat-layout">
                <div class="chat-sidebar">
                    <div style="padding:1rem; font-weight:700; border-bottom:1px solid #eee;">Active Chats</div>
                    <div id="chat-sidebar-list"></div>
                </div>
                <div class="chat-main">
                    <div style="padding:1rem; border-bottom:1px solid #eee; font-weight:700;" id="chat-header-name">Select a conversation</div>
                    <div class="chat-messages" id="chat-box"></div>
                    <div class="chat-input">
                        <input type="text" id="msg-input" placeholder="Ask a question..." onkeypress="handleEnter(event)">
                        <button onclick="sendMessage()" style="background:var(--dark); color:white; border:none; padding:0 2rem; border-radius:8px; cursor:pointer;">Send</button>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <div id="authModal" class="modal">
        <div class="modal-content">
            <span style="position:absolute; top:20px; right:20px; cursor:pointer;" onclick="closeModal()">âœ•</span>
            <h2 id="modal-title" style="margin-bottom: 1rem;">Log In</h2>
            <div class="input-group"><input type="email" id="login-email" placeholder="Email Address"></div>
            <div class="input-group"><input type="password" placeholder="Password"></div>
            <button class="modal-btn" onclick="handleLogin()">Continue</button>
            <p style="margin-top:15px; font-size:0.8rem; color:#94a3b8;">Demo: Enter any email.</p>
        </div>
    </div>

    <script>
        // --- 16 JOBS DATABASE ---
        const jobs = [
            { id: 1, title: "React Frontend Lead", budget: "$3,500", tags: ["React", "Redux"], desc: "Lead the frontend migration." },
            { id: 2, title: "Python Backend API", budget: "$2,000", tags: ["Python", "Django"], desc: "High-performance REST APIs." },
            { id: 3, title: "UX/UI Designer", budget: "$1,800", tags: ["Figma", "Design"], desc: "Mobile app interface design." },
            { id: 4, title: "DevOps Engineer", budget: "$60/hr", tags: ["AWS", "Docker"], desc: "CI/CD pipeline setup." },
            { id: 5, title: "Content Writer", budget: "$500", tags: ["Writing", "SEO"], desc: "Tech blog series." },
            { id: 6, title: "Flutter Developer", budget: "$2,500", tags: ["Mobile", "Flutter"], desc: "Cross-platform app." },
            { id: 7, title: "Data Scientist", budget: "$80/hr", tags: ["Python", "ML"], desc: "Predictive modeling." },
            { id: 8, title: "Brand Identity", budget: "$1,200", tags: ["Design", "Brand"], desc: "Logo and style guide." },
            { id: 9, title: "Java Spring Boot", budget: "$3,000", tags: ["Java", "Backend"], desc: "Enterprise banking system." },
            { id: 10, title: "SEO Specialist", budget: "$40/hr", tags: ["Marketing", "SEO"], desc: "Audit and rank strategy." },
            { id: 11, title: "Video Editor", budget: "$800", tags: ["Video", "Adobe"], desc: "YouTube documentary editing." },
            { id: 12, title: "Virtual Assistant", budget: "$20/hr", tags: ["Admin", "Office"], desc: "Calendar management." },
            { id: 13, title: "Shopify Developer", budget: "$1,500", tags: ["Web", "Shopify"], desc: "Custom theme development." },
            { id: 14, title: "Cyber Security Analyst", budget: "$90/hr", tags: ["Security", "Network"], desc: "Penetration testing." },
            { id: 15, title: "3D Character Modeler", budget: "$1,000", tags: ["3D", "Blender"], desc: "Game asset creation." },
            { id: 16, title: "QA Tester", budget: "$30/hr", tags: ["Testing", "QA"], desc: "Manual and automated testing." }
        ];

        // --- STATE ---
        let currentUser = localStorage.getItem('nexus_user');
        let appliedJobIds = JSON.parse(localStorage.getItem('nexus_jobs')) || [];
        let chatData = JSON.parse(localStorage.getItem('nexus_chats')) || {};
        let activeChatIds = JSON.parse(localStorage.getItem('nexus_active_chats')) || [];
        let currentChatId = null;

        // --- INIT ---
        function init() {
            updateUI();
            renderJobs();
            if(currentUser) {
                renderDashboard();
                renderChatSidebar();
            }
        }

        function updateUI() {
            const guestNav = document.getElementById('nav-guest');
            const userNav = document.getElementById('nav-user');
            
            if (currentUser) {
                guestNav.classList.add('hidden');
                userNav.classList.remove('hidden');
                document.getElementById('badge').innerText = appliedJobIds.length;
                let name = currentUser.split('@')[0];
                document.getElementById('nav-username').innerText = name.charAt(0).toUpperCase() + name.slice(1);
            } else {
                guestNav.classList.remove('hidden');
                userNav.classList.add('hidden');
            }
        }

        // --- SMART DASHBOARD LOGIC ---
        function renderDashboard() {
            // 1. Stats
            document.getElementById('stat-active-jobs').innerText = appliedJobIds.length;
            
            // Calculate Total Value
            let totalVal = 0;
            appliedJobIds.forEach(id => {
                const j = jobs.find(x => x.id === id);
                if(j) {
                    let price = parseInt(j.budget.replace(/[^0-9]/g, ''));
                    totalVal += price;
                }
            });
            document.getElementById('stat-potential-val').innerText = '$' + totalVal.toLocaleString();

            // 2. Activity Feed
            const feed = document.getElementById('activity-feed');
            feed.innerHTML = '';
            if(appliedJobIds.length === 0) {
                feed.innerHTML = '<div style="color:gray; font-size:0.9rem">No active applications.</div>';
            } else {
                [...appliedJobIds].reverse().slice(0, 5).forEach(id => {
                    const job = jobs.find(j => j.id === id);
                    if(job) {
                        feed.innerHTML += `
                            <div class="activity-item">
                                <div style="width:8px;height:8px;background:var(--success);border-radius:50%;margin-top:6px;"></div>
                                <div><div>Applied to <b>${job.title}</b></div><div class="activity-time">Under Review</div></div>
                            </div>`;
                    }
                });
            }

            // 3. SKILL RADAR (Count Tags)
            const skillCounts = {};
            appliedJobIds.forEach(id => {
                const j = jobs.find(x => x.id === id);
                if(j) {
                    j.tags.forEach(tag => {
                        skillCounts[tag] = (skillCounts[tag] || 0) + 1;
                    });
                }
            });

            const skillBox = document.getElementById('skills-container');
            skillBox.innerHTML = '';
            const sortedSkills = Object.entries(skillCounts).sort((a,b) => b[1] - a[1]).slice(0, 4);

            if(sortedSkills.length === 0) {
                skillBox.innerHTML = '<p style="color:gray; font-size:0.9rem;">Apply to jobs to generate your skill profile.</p>';
            } else {
                sortedSkills.forEach(([skill, count]) => {
                    // Fake percentage for visuals
                    let pct = Math.min(100, count * 33); 
                    skillBox.innerHTML += `
                        <div class="skill-bar">
                            <div class="skill-name">${skill}</div>
                            <div class="skill-progress"><div class="skill-fill" style="width:${pct}%"></div></div>
                            <div style="font-size:0.8rem; color:gray;">${count} Jobs</div>
                        </div>`;
                });
            }
        }

        // --- JOB LOGIC ---
        function renderJobs() {
            const container = document.getElementById('job-grid-container');
            container.innerHTML = '';
            const term = document.getElementById('search-input').value.toLowerCase();

            jobs.forEach(job => {
                if (term && !job.title.toLowerCase().includes(term)) return;
                const isApplied = appliedJobIds.includes(job.id);
                const btnText = (currentUser && isApplied) ? "Applied" : "Apply Now";
                const btnClass = (currentUser && isApplied) ? "apply-btn applied" : "apply-btn";

                container.innerHTML += `
                    <div class="job-card">
                        <div><div class="job-title">${job.title}</div><span class="job-budget">${job.budget}</span><p style="color:#64748b;margin:10px 0;font-size:0.9rem">${job.desc}</p></div>
                        <div class="tags">${job.tags.map(t=>`<span>${t}</span>`).join('')}</div>
                        <button class="${btnClass}" onclick="apply(${job.id})">${btnText}</button>
                    </div>`;
            });
        }

        function apply(id) {
            if (!currentUser) { openModal('login'); return; }
            if (appliedJobIds.includes(id)) return;
            
            appliedJobIds.push(id);
            localStorage.setItem('nexus_jobs', JSON.stringify(appliedJobIds));
            
            updateUI();
            renderDashboard(); 
            renderJobs(); 
        }

        // --- WITHDRAW LOGIC (FIXED) ---
        function removeApplication(id) {
            if(!confirm("Are you sure you want to withdraw?")) return;

            // Remove ID
            appliedJobIds = appliedJobIds.filter(jobId => jobId !== id);
            localStorage.setItem('nexus_jobs', JSON.stringify(appliedJobIds));
            
            // Remove Chat
            activeChatIds = activeChatIds.filter(chatId => chatId !== id);
            localStorage.setItem('nexus_active_chats', JSON.stringify(activeChatIds));
            
            updateUI();
            renderDashboard();
            renderMyJobs(); // Update My Jobs View
            renderJobs();   // IMPORTANT: Update Browse View (Green -> Blue)
        }

        function renderMyJobs() {
            const container = document.getElementById('my-jobs-grid');
            container.innerHTML = '';
            if (appliedJobIds.length === 0) { container.innerHTML = "<p>No active applications.</p>"; return; }

            appliedJobIds.forEach(id => {
                const job = jobs.find(j => j.id === id);
                if(job) {
                    container.innerHTML += `
                        <div class="job-card" style="flex-direction:row; align-items:center; height:auto;">
                            <div style="flex:1">
                                <div class="job-title">${job.title}</div>
                                <span class="job-budget">${job.budget}</span>
                            </div>
                            <div style="display:flex;">
                                <button class="apply-btn" style="margin:0; width:auto; padding:0.5rem 1rem;" onclick="initiateChat(${job.id})">Message</button>
                                <button class="withdraw-btn" onclick="removeApplication(${job.id})">Withdraw</button>
                            </div>
                        </div>`;
                }
            });
        }

        // --- SMART CHAT ---
        function initiateChat(jobId) {
            if (!activeChatIds.includes(jobId)) {
                activeChatIds.push(jobId);
                localStorage.setItem('nexus_active_chats', JSON.stringify(activeChatIds));
            }
            if (!chatData[jobId]) {
                chatData[jobId] = [
                    { type: 'in', text: `System: Application submitted for Job #${jobId}` },
                    { type: 'in', text: "Hi! Ask me about Budget, Skills, or Role details." }
                ];
                localStorage.setItem('nexus_chats', JSON.stringify(chatData));
            }
            switchView('messages');
            loadChat(jobId);
        }

        function loadChat(jobId) {
            currentChatId = jobId;
            const job = jobs.find(j => j.id === jobId);
            document.getElementById('chat-header-name').innerText = job.title;
            const box = document.getElementById('chat-box');
            box.innerHTML = '';
            (chatData[jobId] || []).forEach(m => {
                box.innerHTML += `<div class="message ${m.type === 'in' ? 'msg-in' : 'msg-out'}">${m.text}</div>`;
            });
            renderChatSidebar();
            box.scrollTop = box.scrollHeight;
        }

        function renderChatSidebar() {
            const list = document.getElementById('chat-sidebar-list');
            list.innerHTML = '';
            activeChatIds.forEach(id => {
                const job = jobs.find(j => j.id === id);
                if(job) {
                    const isActive = (id === currentChatId) ? 'active' : '';
                    list.innerHTML += `<div class="chat-item ${isActive}" onclick="loadChat(${id})"><div class="user-avatar">${job.title[0]}</div><b>${job.title}</b></div>`;
                }
            });
        }

        function sendMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value;
            if(!text || !currentChatId) return;

            const box = document.getElementById('chat-box');
            box.innerHTML += `<div class="message msg-out">${text}</div>`;
            box.scrollTop = box.scrollHeight;
            
            if(!chatData[currentChatId]) chatData[currentChatId] = [];
            chatData[currentChatId].push({ type: 'out', text: text });
            input.value = '';

            // BOT AI
            setTimeout(() => {
                let botReply = "I've noted that request.";
                const lowerText = text.toLowerCase();
                const currentJob = jobs.find(j => j.id === currentChatId);

                if(lowerText.includes('salary') || lowerText.includes('budget')) {
                    botReply = `The budget is **${currentJob.budget}**.`;
                } else if(lowerText.includes('remote')) {
                    botReply = "Yes, this role is fully remote.";
                } else if(lowerText.includes('skill')) {
                    botReply = `We need: ${currentJob.tags.join(', ')}.`;
                } else if(lowerText.includes('hi')) {
                    botReply = "Hello! How can I help you today?";
                }

                box.innerHTML += `<div class="message msg-in">${botReply}</div>`;
                box.scrollTop = box.scrollHeight;
                
                chatData[currentChatId].push({ type: 'in', text: botReply });
                localStorage.setItem('nexus_chats', JSON.stringify(chatData));
            }, 800);
            localStorage.setItem('nexus_chats', JSON.stringify(chatData));
        }
        
        function handleEnter(e) { if(e.key === 'Enter') sendMessage(); }

        // --- UTILS ---
        function handleLogin() {
            const email = document.getElementById('login-email').value;
            if(!email) return alert("Enter email");
            localStorage.setItem('nexus_user', email);
            currentUser = email;
            closeModal();
            init();
            switchView('dashboard');
        }
        function logout() { localStorage.removeItem('nexus_user'); location.reload(); }
        function switchView(viewName) {
            if (!currentUser && viewName !== 'home') { openModal('login'); return; }
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${viewName}`).classList.add('active');
            if(viewName === 'myjobs') renderMyJobs();
            if(viewName === 'messages') renderChatSidebar();
        }
        function handleLogoClick() { currentUser ? toggleProfileMenu(event) : switchView('home'); }
        function toggleProfileMenu(e) { e.stopPropagation(); const m = document.getElementById('profile-dropdown'); m.style.display = m.style.display==='flex'?'none':'flex'; }
        function closeDropdown() { document.getElementById('profile-dropdown').style.display = 'none'; }
        const modal = document.getElementById('authModal');
        function openModal(t) { modal.style.display = 'flex'; }
        function closeModal() { modal.style.display = 'none'; }
        window.onclick = e => { if(e.target == modal) closeModal(); }

        init();
    </script>
</body>
</html>